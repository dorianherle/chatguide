┌─────────────────────────────────────────────────────────────────┐
│                         USER TURN STARTS                         │
└─────────────────────────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  ChatService.send_message(user_input)         │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  guide.add_user_message(user_input)           │
    │  → adds to state.conversation.history         │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  outgoing_prompt = guide.get_prompt()         │
    │                                               │
    │  PromptBuilder reads:                         │
    │  ├─ state.conversation.memory                 │
    │  ├─ state.conversation.history                │
    │  ├─ state.tracker.results (Known info)        │
    │  ├─ state.flow.current_batch (tasks)          │
    │  └─ state.flow.persistent_tasks               │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  reply = guide.chat()                         │
    │  → calls LLM with prompt                      │
    └───────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      LLM RESPONSE RECEIVED                       │
│  {                                                               │
│    "tasks": [...],                                               │
│    "persistent_tasks": [                                         │
│      {"task_id": "detect_info_updates",                          │
│       "result": "update: get_name = John"}                       │
│    ],                                                            │
│    "assistant_reply": "Thirty-two! Got it, Dorian!"             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  _process_reply(reply)                        │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  STEP 1: Process batch tasks                  │
    │  → update state.tracker.results               │
    │  → update state.tracker.status                │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  STEP 2: Process persistent tasks             │
    │  → update state.tracker.results               │
    │    (including detect_info_updates)            │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  STEP 3: Execute routes (_process_routes)     │  ← CRITICAL
    │                                               │
    │  For each route in config:                    │
    │  ├─ Evaluate condition (RouteEvaluator)       │
    │  └─ If true → execute action                  │
    │                                               │
    │  Special action: "process_corrections"        │
    │  ├─ Read detect_info_updates result           │
    │  ├─ Parse "update: task_id = value"           │
    │  └─ Apply to state.tracker.results            │
    │     BEFORE history update                     │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  STEP 4: Update conversation history          │  ← NOW SAFE
    │  → state.conversation.add_message(            │
    │      chatbot, reply.assistant_reply)          │
    │                                               │
    │  History now contains corrected state         │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  STEP 5: Try to advance flow                  │
    │  → if no current tasks left                   │
    │    state.flow.advance()                       │
    └───────────────────────────────────────────────┘
                                ↓
    ┌───────────────────────────────────────────────┐
    │  Return reply to user                         │
    └───────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      WAIT FOR NEXT USER INPUT                    │
└─────────────────────────────────────────────────────────────────┘